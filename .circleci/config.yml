# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
    browser-tools: circleci/browser-tools@1.1.0
    codecov: codecov/codecov@3.2.4

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
    frontend-build:
        working_directory: ~/project/app/mikane
        docker:
            - image: cimg/node:16.20.1-browsers
        steps:
            - checkout:
                  path: ~/project
            - browser-tools/install-browser-tools
            - run: |
                  node --version
                  google-chrome --version
            - restore_cache:
                  key: mikane-{{ .Branch }}-{{ checksum "package.json" }}
            - run: npm install
            - save_cache:
                  key: mikane-{{ .Branch }}-{{ checksum "package.json" }}
                  paths:
                      - "node_modules"
            - run: xvfb-run -a npm run build
            - run: xvfb-run -a npm run test
            - store_test_results:
                  path: junit
            - store_artifacts:
                  path: coverage
            #- codecov/upload:
            #      file: './coverage/mikane/cobertura-coverage.xml'

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
    build-workflow:
        jobs:
            - frontend-build
